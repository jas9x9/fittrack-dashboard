# Implementation Guide: Adding `startingValue` Field to Goals

## Overview
This document outlines all changes needed to add a `startingValue` field to goals, which captures the initial baseline value against which progress is measured.

## Changes Required

### **1. DATABASE LAYER**

#### **A. Schema Changes** (`shared/schema.ts`)

**Location: Lines 13-22**
```typescript
export const goals = pgTable("goals", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  exerciseId: varchar("exercise_id").references(() => exercises.id).notNull(),
  startingValue: real("starting_value").notNull(),  // ← NEW FIELD
  targetValue: real("target_value").notNull(),
  targetDate: timestamp("target_date").notNull(),
  currentValue: real("current_value").default(0),
  unit: text("unit").notNull().default("KGs"),
  isActive: integer("is_active").default(1),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});
```

**Location: Lines 38-46**
```typescript
export const insertGoalSchema = createInsertSchema(goals).omit({
  id: true,
  createdAt: true,
}).extend({
  startingValue: z.coerce.number().min(0),  // ← NEW VALIDATION
  targetValue: z.coerce.number().positive(),
  currentValue: z.coerce.number().min(0).optional(),
  targetDate: z.coerce.date(),
  unit: z.string().min(1, "Unit is required"),
});
```

#### **B. Database Migration**
```bash
# Run migration to add column
cd fittrack-dashboard
npm run db:push
```

**Migration SQL (auto-generated by Drizzle):**
```sql
ALTER TABLE goals
ADD COLUMN starting_value REAL NOT NULL DEFAULT 0;
```

---

### **2. SERVER/API LAYER**

#### **A. Business Logic Validation** (`server/routes/goals.ts`)

**Location: Lines 38-43 - POST /api/goals**
```typescript
const validatedData = insertGoalSchema.parse(req.body);

// Add validation: target > starting
if (validatedData.targetValue <= validatedData.startingValue) {
  return res.status(400).json({
    message: 'Target value must be greater than starting value'
  });
}

// Existing validation for target > current remains
if (validatedData.targetValue <= (validatedData.currentValue || 0)) {
  return res.status(400).json({
    message: 'Target value must be greater than current value'
  });
}
```

**Location: Lines 66-73 - PUT /api/goals/:id**
```typescript
// Business logic validation for updates
if (validatedData.targetValue !== undefined &&
    validatedData.startingValue !== undefined) {
  if (validatedData.targetValue <= validatedData.startingValue) {
    return res.status(400).json({
      message: 'Target value must be greater than starting value'
    });
  }
}

if (validatedData.targetValue !== undefined &&
    validatedData.currentValue !== undefined) {
  if (validatedData.targetValue <= validatedData.currentValue) {
    return res.status(400).json({
      message: 'Target value must be greater than current value'
    });
  }
}
```

#### **B. Storage Layer** (`server/storage/storage.ts`)
No changes needed - Drizzle ORM automatically handles the new field in insert/update operations.

---

### **3. CLIENT/FRONTEND LAYER**

#### **A. Type Definitions** (`client/src/api/client.ts`)

**Location: Lines 199-208**
```typescript
export interface GoalApiResponse {
  id: string;
  exerciseId: string;
  startingValue: number;  // ← NEW FIELD
  targetValue: number;
  targetDate: string;
  currentValue: number;
  unit: string;
  isActive: number;
  createdAt: string;
}
```

**Location: Lines 232-241**
```typescript
export interface Goal {
  id: string;
  exerciseId: string;
  startingValue: number;  // ← NEW FIELD
  targetValue: number;
  targetDate: Date;
  currentValue: number;
  unit: string;
  isActive: number;
  createdAt: Date;
}
```

**Location: Lines 264-270**
```typescript
export interface CreateGoalRequest {
  exerciseId: string;
  startingValue: number;  // ← NEW FIELD
  targetValue: number;
  targetDate: string | Date;
  currentValue?: number;
  unit: string;
}
```

**Location: Lines 272-278**
```typescript
export interface UpdateGoalRequest {
  exerciseId?: string;
  startingValue?: number;  // ← NEW FIELD
  targetValue?: number;
  targetDate?: string | Date;
  currentValue?: number;
  unit?: string;
}
```

**Location: Lines 346-356**
```typescript
goal(apiResponse: GoalApiResponse): Goal {
  return {
    id: apiResponse.id,
    exerciseId: apiResponse.exerciseId,
    startingValue: apiResponse.startingValue,  // ← NEW FIELD
    targetValue: apiResponse.targetValue,
    targetDate: dateUtils.fromApiString(apiResponse.targetDate),
    currentValue: apiResponse.currentValue,
    unit: apiResponse.unit,
    isActive: apiResponse.isActive,
    createdAt: dateUtils.fromApiString(apiResponse.createdAt),
  };
},
```

#### **B. AddGoalDialog Component** (`client/src/components/AddGoalDialog.tsx`)

**Location: Lines 35-42 - Update interface**
```typescript
interface AddGoalDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  exercises: Exercise[];
  onSubmit: (goal: {
    exerciseId: string;
    startingValue: number;  // ← NEW FIELD
    currentValue: number;
    targetValue: number;
    unit: string;
    targetDate: Date;
  }) => void;
}
```

**Location: Lines 46-51 - Add state**
```typescript
const [exerciseId, setExerciseId] = useState("");
const [startingValue, setStartingValue] = useState("");  // ← NEW STATE
const [currentValue, setCurrentValue] = useState("");
const [targetValue, setTargetValue] = useState("");
const [unit, setUnit] = useState("KGs");
const [targetDate, setTargetDate] = useState<Date>();
const [errors, setErrors] = useState<Record<string, string>>({});
```

**Location: Lines 58-95 - Update validation and submit handler**
```typescript
const handleSubmit = (e: React.FormEvent) => {
  e.preventDefault();

  const newErrors: Record<string, string> = {};

  if (!exerciseId) newErrors.exerciseId = "Exercise is required";
  if (!startingValue) newErrors.startingValue = "Starting value is required";  // ← NEW
  if (!currentValue) newErrors.currentValue = "Current value is required";
  if (!targetValue) newErrors.targetValue = "Target value is required";
  if (!targetDate) newErrors.targetDate = "Target date is required";

  // Validate: starting <= current < target
  if (startingValue && currentValue &&
      parseFloat(currentValue) < parseFloat(startingValue)) {
    newErrors.currentValue = "Current value must be >= starting value";
  }

  if (currentValue && targetValue &&
      parseFloat(targetValue) <= parseFloat(currentValue)) {
    newErrors.targetValue = "Target value must be > current value";
  }

  setErrors(newErrors);
  if (Object.keys(newErrors).length > 0) return;
  if (!targetDate) return;

  onSubmit({
    exerciseId,
    startingValue: parseFloat(startingValue),  // ← NEW
    currentValue: parseFloat(currentValue),
    targetValue: parseFloat(targetValue),
    unit,
    targetDate,
  });

  // Reset form
  setExerciseId("");
  setStartingValue("");  // ← NEW
  setCurrentValue("");
  setTargetValue("");
  setUnit("KGs");
  setTargetDate(undefined);
  setErrors({});
  setCalendarOpen(false);
  onOpenChange(false);
};
```

**Location: After Exercise selection field (around line 127) - Add JSX input field**
```tsx
{/* Starting Value Input - ADD THIS */}
<div className="space-y-2">
  <Label htmlFor="startingValue">
    Starting Value <span className="text-red-500">*</span>
  </Label>
  <div className="flex items-center gap-2">
    <Input
      id="startingValue"
      type="number"
      value={startingValue}
      onChange={(e) => {
        setStartingValue(e.target.value);
        if (errors.startingValue)
          setErrors(prev => ({ ...prev, startingValue: "" }));
      }}
      placeholder="Enter starting value"
      className={`flex-1 ${errors.startingValue ? "border-red-500" : ""}`}
      data-testid="input-starting-value"
    />
    <Select value={unit} onValueChange={setUnit}>
      <SelectTrigger className="w-24" data-testid="select-starting-unit">
        <SelectValue placeholder="Unit" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="KGs">
          <span className="text-foreground">KGs</span>
        </SelectItem>
        <SelectItem value="Reps">
          <span className="text-foreground">Reps</span>
        </SelectItem>
        <SelectItem value="KMs">
          <span className="text-foreground">KMs</span>
        </SelectItem>
      </SelectContent>
    </Select>
  </div>
  {errors.startingValue && (
    <p className="text-sm text-red-500">{errors.startingValue}</p>
  )}
</div>

{/* Current Value field - KEEP EXISTING */}
{/* Target Value field - KEEP EXISTING */}
```

#### **C. EditGoalDialog Component** (`client/src/components/EditGoalDialog.tsx`)

Make similar changes as AddGoalDialog:
1. Add `startingValue` to props interface
2. Add `startingValue` state
3. Add validation for starting <= current < target
4. Add input field in JSX (similar to AddGoalDialog)
5. Include `startingValue` in onSubmit call
6. Reset `startingValue` in form reset

#### **D. Goals Page** (`client/src/pages/Goals.tsx`)

**Location: Lines 16-28 - Update convertGoalForCard**
```typescript
function convertGoalForCard(goal: GoalWithExercise) {
  return {
    id: goal.id,
    exerciseName: goal.exercise?.name || 'Unknown Exercise',
    startingValue: goal.startingValue,  // ← NEW
    currentValue: goal.currentValue,
    targetValue: goal.targetValue,
    unit: goal.unit,
    targetDate: dateUtils.formatForDisplay(goal.targetDate),
    daysLeft: dateUtils.daysUntil(goal.targetDate),
    isCompleted: goal.isActive === 0
  };
}
```

**Location: Lines 72-80 - Update handleUpdateGoal**
```typescript
const handleUpdateGoal = (
  goalId: string,
  updates: {
    exerciseName: string;
    startingValue: number;  // ← NEW
    currentValue: number;
    targetValue: number;
    unit: string;
    targetDate: Date
  }
) => {
  const updateData: UpdateGoalRequest = {
    startingValue: updates.startingValue,  // ← NEW
    currentValue: updates.currentValue,
    targetValue: updates.targetValue,
    unit: updates.unit,
    targetDate: updates.targetDate,
  };

  updateGoalMutation.mutate({ id: goalId, data: updateData });
};
```

**Location: Lines 90-104 - Update handleAddGoal**
```typescript
const handleAddGoal = (goalData: {
  exerciseId: string;
  startingValue: number;  // ← NEW
  currentValue: number;
  targetValue: number;
  unit: string;
  targetDate: Date
}) => {
  const createData: CreateGoalRequest = {
    exerciseId: goalData.exerciseId,
    startingValue: goalData.startingValue,  // ← NEW
    currentValue: goalData.currentValue,
    targetValue: goalData.targetValue,
    unit: goalData.unit,
    targetDate: goalData.targetDate,
  };

  createGoalMutation.mutate(createData, {
    onSuccess: () => setShowAddGoal(false)
  });
};
```

**Location: Lines 191-199 - Update EditGoalDialog data passing**
```typescript
<EditGoalDialog
  open={showEditGoal}
  onOpenChange={(open) => {
    setShowEditGoal(open);
    if (!open) setSelectedGoalForEdit(null);
  }}
  goal={selectedGoalForEdit && selectedGoalForEdit.exercise ? {
    id: selectedGoalForEdit.id,
    exerciseName: selectedGoalForEdit.exercise.name,
    startingValue: selectedGoalForEdit.startingValue,  // ← NEW
    currentValue: selectedGoalForEdit.currentValue,
    targetValue: selectedGoalForEdit.targetValue,
    unit: selectedGoalForEdit.unit,
    targetDate: dateUtils.formatForInput(selectedGoalForEdit.targetDate)
  } : null}
  exercises={exercises || []}
  onSubmit={handleUpdateGoal}
/>
```

#### **E. GoalCard Component** (`client/src/components/GoalCard.tsx`)

**Location: Lines 8-19 - Update interface**
```typescript
interface GoalCardProps {
  id: string;
  exerciseName: string;
  startingValue: number;  // ← NEW
  currentValue: number;
  targetValue: number;
  unit: string;
  targetDate: string;
  onEdit?: (id: string) => void;
  onAddProgress?: (id: string) => void;
  progressData?: WorkoutProgress[];
  className?: string;
}
```

**Location: Lines 43-58 - Update component body**
```typescript
export function GoalCard({
  id,
  exerciseName,
  startingValue,  // ← NEW
  currentValue,
  targetValue,
  unit,
  targetDate,
  onEdit,
  onAddProgress,
  progressData,
  className = ""
}: GoalCardProps) {
  // Calculate progress based on starting value
  const totalProgress = targetValue - startingValue;
  const currentProgress = currentValue - startingValue;
  const progress = Math.min((currentProgress / totalProgress) * 100, 100);

  const isCompleted = currentValue >= targetValue;
  const daysRemaining = Math.ceil(
    (new Date(targetDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)
  );

  // ... rest of component
}
```

**Location: Lines 70-99 - Update display section**
```tsx
<CardContent>
  <div className="mb-2">
    {/* Add Starting Value Display */}
    <div className="text-xs text-muted-foreground mb-2">
      Starting: {startingValue} {unit}
    </div>

    <div className="flex items-center gap-2 mb-2">
      <Target className="h-4 w-4 text-muted-foreground" />
      <span className="text-sm font-mono">
        {currentValue} / {targetValue} {unit}
      </span>
      {isCompleted && (
        <PartyPopper className="h-4 w-4 text-primary" data-testid="icon-goal-achieved" />
      )}
    </div>

    <Progress value={progress} className="h-2 mb-2" />

    <div className="flex items-center justify-between text-xs text-muted-foreground mb-2">
      <div className="flex items-center gap-1">
        <Calendar className="h-3 w-3" />
        <span>
          {daysRemaining > 0 ? `${daysRemaining} days left` :
           daysRemaining === 0 ? 'Due today' :
           `${Math.abs(daysRemaining)} days overdue`}
        </span>
      </div>
      <span>{Math.round(progress)}% complete</span>
    </div>

    <WorkoutChart
      data={formatProgressForChart(progressData, currentValue)}
      title="Recent Progress"
      unit={unit}
      className="border-t pt-2"
    />
  </div>

  {onAddProgress && (
    <Button
      onClick={() => onAddProgress(id)}
      className="w-full"
      size="sm"
      data-testid={`button-add-progress-${id}`}
    >
      <Plus className="h-4 w-4 mr-2" />
      Log Progress
    </Button>
  )}
</CardContent>
```

---

### **4. SEED DATA** (Optional)

**File:** `server/storage/seed.ts`

Update existing seed data to include startingValue:
```typescript
await storage.createGoal({
  exerciseId: benchPressId,
  startingValue: 60,  // ← NEW: Starting from 60 KGs
  currentValue: 80,
  targetValue: 100,
  unit: "KGs",
  targetDate: new Date("2025-12-31")
});

await storage.createGoal({
  exerciseId: squatId,
  startingValue: 80,  // ← NEW: Starting from 80 KGs
  currentValue: 110,
  targetValue: 140,
  unit: "KGs",
  targetDate: new Date("2025-11-30")
});
```

---

## Summary

### **Files to Modify:**

| # | File | Changes |
|---|------|---------|
| 1 | `shared/schema.ts` | Add field to table schema + Zod validation |
| 2 | `server/routes/goals.ts` | Add business logic validation |
| 3 | `client/src/api/client.ts` | Add to all type definitions + converter |
| 4 | `client/src/components/AddGoalDialog.tsx` | Add input field + state + validation |
| 5 | `client/src/components/EditGoalDialog.tsx` | Add input field + state + validation |
| 6 | `client/src/components/GoalCard.tsx` | Display starting value + adjust progress calculation |
| 7 | `client/src/pages/Goals.tsx` | Pass startingValue in all handlers |
| 8 | `server/storage/seed.ts` | (Optional) Update seed data |
| 9 | Database (Neon) | Run migration: `npm run db:push` |

### **Total: 8 files + 1 database migration**

---

## Implementation Steps

1. **Start with database:**
   - Update `shared/schema.ts`
   - Run `npm run db:push` to apply migration

2. **Update server validation:**
   - Modify `server/routes/goals.ts`

3. **Update client types:**
   - Modify `client/src/api/client.ts`

4. **Update UI components:**
   - Modify `AddGoalDialog.tsx`
   - Modify `EditGoalDialog.tsx`
   - Modify `GoalCard.tsx`
   - Modify `Goals.tsx`

5. **Test:**
   - Create new goal with starting value
   - Edit existing goal
   - Verify progress calculation uses starting value
   - Verify validation works correctly

6. **(Optional) Update seed data:**
   - Modify `server/storage/seed.ts`
   - Re-run seed script if needed

---

## Validation Rules

The following validation rules should be enforced:

1. **startingValue** is required
2. **startingValue** must be >= 0
3. **currentValue** must be >= **startingValue**
4. **targetValue** must be > **currentValue**
5. Therefore: **startingValue** <= **currentValue** < **targetValue**

---

## Progress Calculation

**Before (without startingValue):**
```typescript
progress = (currentValue / targetValue) * 100
```

**After (with startingValue):**
```typescript
totalProgress = targetValue - startingValue
currentProgress = currentValue - startingValue
progress = (currentProgress / totalProgress) * 100
```

This gives a more accurate representation of progress from the starting point to the target.

---

**Document Created:** September 29, 2025
**Status:** Ready for implementation